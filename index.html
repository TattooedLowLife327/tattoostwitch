<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="theme-color" content="#8B5CF6" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<title>Tattoo's Twitch</title>
<style>
  :root {
    --purple: #8B5CF6;
    --dark: #111111;
    --text: #ffffff;
    --muted: #a3a3a3;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: url('images/background.png') center center / cover no-repeat fixed;
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
  }

  h1 {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
    color: var(--purple);
    font-size: 28px;
  }

  h1 img {
    width: 50px;
    height: 50px;
    object-fit: contain;
  }

  .login-form {
    background: rgba(17, 17, 17, 0.95);
    border: 2px solid rgba(139, 92, 246, 0.5);
    border-radius: 12px;
    padding: 30px;
    margin-top: 100px;
  }

  .login-form h2 {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 20px;
    color: var(--purple);
  }

  .login-form h2 img {
    width: 40px;
    height: 40px;
    object-fit: contain;
  }

  input {
    width: 100%;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 8px;
    color: var(--text);
    font-size: 16px;
    margin-bottom: 15px;
  }

  input:focus {
    outline: none;
    border-color: var(--purple);
  }

  .btn {
    width: 100%;
    padding: 15px;
    background: var(--purple);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn:active {
    transform: scale(0.98);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .error {
    color: #ff6b6b;
    text-align: center;
    margin-top: 10px;
  }

  .section {
    background: rgba(17, 17, 17, 0.95);
    border: 2px solid rgba(139, 92, 246, 0.5);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .section h2 {
    color: var(--purple);
    margin-bottom: 15px;
    font-size: 20px;
  }

  .queue-item {
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
  }

  .queue-item .title {
    font-weight: 600;
    margin-bottom: 5px;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
  }

  .queue-item .info {
    color: var(--muted);
    font-size: 14px;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
  }

  .btn-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .btn-small {
    flex: 1;
    padding: 10px;
    background: var(--purple);
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-small.deny {
    background: #ff6b6b;
  }

  .scoreboard-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .score-section {
    text-align: center;
  }

  .score-section label {
    display: block;
    color: var(--muted);
    margin-bottom: 8px;
    font-size: 14px;
  }

  .score-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .score-display {
    font-size: 32px;
    font-weight: 900;
    color: var(--purple);
    min-width: 60px;
  }

  .score-btn {
    width: 40px;
    height: 40px;
    background: var(--purple);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
  }

  .hidden {
    display: none;
  }

  .status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: 600;
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  .status.connected {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
  }

  .status.connected .status-dot {
    background: #4caf50;
    box-shadow: 0 0 8px #4caf50;
  }

  .status.disconnected {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
  }

  .status.disconnected .status-dot {
    background: #f44336;
    box-shadow: 0 0 8px #f44336;
    animation: none;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .logout-btn {
    background: #ff6b6b;
    margin-top: 20px;
  }

  .spotify-player {
    position: relative;
    background: linear-gradient(135deg, rgba(17,17,17,0.98) 0%, rgba(17,17,17,0.95) 100%);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 12px;
    padding: 20px;
    min-height: 290px;
  }

  .spotify-player::before {
    content: '';
    position: absolute;
    inset: -3px;
    border-radius: 12px;
    padding: 3px;
    background: conic-gradient(
      from 0deg at 50% 50%,
      rgba(139, 92, 246, 1) 0deg,
      rgba(168, 85, 247, 1) calc(var(--progress, 0) * 3.6deg),
      transparent calc(var(--progress, 0) * 3.6deg)
    );
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    z-index: 1;
    filter: blur(6px) brightness(1.5);
    opacity: 1;
  }

  .spotify-player::after {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 12px;
    padding: 2px;
    background: conic-gradient(
      from 0deg at 50% 50%,
      #8B5CF6 0deg,
      #A855F7 calc(var(--progress, 0) * 3.6deg),
      transparent calc(var(--progress, 0) * 3.6deg)
    );
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
    z-index: 2;
  }

  .player-layout {
    position: relative;
    z-index: 3;
    display: flex;
    flex-direction: column;
    gap: 16px;
    align-items: center;
    justify-content: center;
    height: 100%;
  }

  .album-art-container {
    position: relative;
    flex-shrink: 0;
  }

  .album-glow {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(139, 92, 246, 0.1) 50%, rgba(168, 85, 247, 0.2) 100%);
    border-radius: 8px;
    filter: blur(12px);
    transform: scale(1.05);
  }

  .album-art {
    position: relative;
    width: 160px;
    height: 160px;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(139, 92, 246, 0.1) 100%);
    border: 2px solid rgba(139, 92, 246, 0.4);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .album-art:hover {
    transform: scale(1.05);
    border-color: rgba(139, 92, 246, 0.6);
  }

  .album-art img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }

  .music-notes {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: visible;
    z-index: 3;
  }

  .music-notes.paused .music-note {
    animation-play-state: paused;
    opacity: 0;
  }

  .music-note {
    position: absolute;
    color: #FFFFFF;
    opacity: 0;
    font-size: 28px;
    font-weight: 900;
    animation: float-up 4s ease-in infinite;
    text-shadow:
      -1px -1px 0 #000,
      1px -1px 0 #000,
      -1px 1px 0 #000,
      1px 1px 0 #000,
      0 0 15px #A855F7,
      0 0 30px #A855F7,
      0 0 45px #8B5CF6;
    -webkit-text-stroke: 1px rgba(0, 0, 0, 0.5);
  }

  .music-note:nth-child(1) {
    left: 10%;
    animation-delay: 0s;
  }

  .music-note:nth-child(2) {
    left: 50%;
    animation-delay: 1.5s;
  }

  .music-note:nth-child(3) {
    left: 80%;
    animation-delay: 3s;
  }

  @keyframes float-up {
    0% {
      bottom: -10px;
      opacity: 0;
      transform: translateY(0) rotate(0deg);
    }
    20% {
      opacity: 1;
    }
    80% {
      opacity: 1;
    }
    100% {
      bottom: 100%;
      opacity: 0;
      transform: translateY(-20px) rotate(15deg);
    }
  }

  .player-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 8px;
    width: 100%;
    padding: 0 20px;
  }

  .track-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    word-wrap: break-word;
    line-height: 1.3;
    width: 100%;
  }

  .track-artist {
    font-size: 18px;
    color: var(--muted);
    word-wrap: break-word;
    line-height: 1.3;
    width: 100%;
  }

  .track-playlist {
    font-size: 16px;
    color: var(--purple);
    word-wrap: break-word;
    line-height: 1.3;
    width: 100%;
  }

  .spotify-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
    margin-top: 15px;
  }

  .control-btn {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--purple) 0%, rgba(168, 85, 247, 1) 100%);
    border: 1px solid rgba(139, 92, 246, 0.5);
    border-radius: 50%;
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }

  .control-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
  }

  .control-btn:active {
    transform: scale(0.95);
  }

</style>
</head>
<body>

<div id="login-screen" class="container">
  <div class="login-form">
    <img src="images/bannerphoto.png" alt="Tattoo's Twitch Banner" style="width: 100%; max-width: 500px; margin-bottom: 20px;">
    <input type="password" id="pin-input" placeholder="Enter PIN" autocomplete="off" inputmode="numeric" />
    <button class="btn" onclick="login()">Login</button>
    <div id="login-error" class="error hidden"></div>
  </div>
</div>

<div id="admin-screen" class="container hidden">
  <img src="images/bannerphoto.png" alt="Tattoo's Twitch Banner" style="width: 100%; max-width: 600px; margin-bottom: 30px;">

  <div id="connection-status" class="status disconnected">
    <span class="status-dot"></span>
    <span>Connecting...</span>
  </div>

  <div class="section">
    <h2>Active Admin</h2>
    <div id="admin-status" style="text-align: center; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; margin-bottom: 10px;">
      <div style="font-size: 18px; font-weight: 600; color: var(--purple);">
        Current Admin: <span id="current-admin-name">None</span>
      </div>
      <div id="admin-since" style="color: var(--muted); font-size: 14px; margin-top: 5px;"></div>
    </div>
    <div id="boot-section" class="hidden" style="text-align: center;">
      <button class="btn" style="background: #ff6b6b;" onclick="bootAdmin()">Boot Current Admin</button>
    </div>
    <div id="checkout-section" class="hidden" style="text-align: center;">
      <button class="btn" style="background: #ff9800;" onclick="checkoutAdmin()">Check Out</button>
    </div>
  </div>

  <div id="admin-management" class="section hidden">
    <h2>Admin Management</h2>
    <div style="margin-bottom: 20px;">
      <h3 style="color: var(--purple); margin-bottom: 10px;">Add New Admin</h3>
      <input type="text" id="new-admin-name" placeholder="Admin Name" style="margin-bottom: 10px;" />
      <input type="text" id="new-admin-pin" placeholder="PIN (4+ digits)" style="margin-bottom: 10px;" />
      <button class="btn" onclick="addAdmin()">Add Admin</button>
    </div>
    <div>
      <h3 style="color: var(--purple); margin-bottom: 10px;">Current Admins</h3>
      <div id="admin-list"></div>
    </div>
  </div>

  <div class="section">
    <h2>Now Playing</h2>
    <div class="spotify-player">
      <div class="player-layout">
        <!-- Album Art -->
        <div class="album-art-container">
          <div class="album-glow"></div>
          <div class="album-art" id="album-art">
            <svg viewBox="0 0 24 24" fill="white" style="width: 64px; height: 64px;">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
            </svg>
          </div>
          <div class="music-notes" id="music-notes">
            <div class="music-note">‚ô™</div>
            <div class="music-note">‚ô´</div>
            <div class="music-note">‚ô™</div>
          </div>
        </div>

        <!-- Player Info -->
        <div class="player-info">
          <div class="track-title" id="track-title">‚Äî</div>
          <div class="track-artist" id="track-artist">‚Äî</div>
          <div class="track-playlist" id="track-playlist"></div>
        </div>
      </div>
    </div>
    <div class="spotify-controls">
      <button class="control-btn" onclick="togglePlayPause()" id="play-pause-btn">‚ñ∂</button>
      <button class="control-btn" onclick="skipSong()">‚è≠</button>
    </div>
  </div>

  <div class="section">
    <h2>Pending Song Requests</h2>
    <div id="pending-queue"></div>
  </div>

  <div class="section">
    <h2>Channel Stats</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center;">
      <div>
        <div style="color: var(--muted); font-size: 14px; margin-bottom: 5px;">Followers</div>
        <div style="font-size: 48px; font-weight: 900; color: var(--purple);">
          <span id="follower-count">---</span>
        </div>
      </div>
      <div>
        <div style="color: var(--muted); font-size: 14px; margin-bottom: 5px;">Subscribers</div>
        <div style="font-size: 48px; font-weight: 900; color: var(--purple);">
          <span id="subscriber-count">---</span>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 style="display: flex; justify-content: space-between; align-items: center;">
      Scoreboard
      <button onclick="toggleScoreboardEdit()" style="background: none; border: none; color: var(--purple); cursor: pointer; font-size: 20px; padding: 5px;">‚úèÔ∏è</button>
    </h2>
    <div id="scoreboard-edit-section" class="hidden" style="margin-bottom: 15px;">
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Player 1 Name</label>
        <input type="text" id="player1-name" placeholder="TATTOO" value="TATTOO" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Player 2 Name</label>
        <input type="text" id="player2-name" placeholder="OPEN" value="OPEN" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
      </div>
      <button class="btn" onclick="saveScoreboardNames()" style="width: 100%; background: #10b981;">Save Names</button>
    </div>
    <div class="scoreboard-controls">
      <div class="score-section">
        <label>Player 1 (TATTOO)</label>
        <div class="score-controls">
          <button class="score-btn" onclick="updateScore('player1', -1)">-</button>
          <div class="score-display" id="score1">0</div>
          <button class="score-btn" onclick="updateScore('player1', 1)">+</button>
        </div>
      </div>
      <div class="score-section">
        <label>Player 2 (OPEN)</label>
        <div class="score-controls">
          <button class="score-btn" onclick="updateScore('player2', -1)">-</button>
          <div class="score-display" id="score2">0</div>
          <button class="score-btn" onclick="updateScore('player2', 1)">+</button>
        </div>
      </div>
    </div>
    <button class="btn" style="margin-top: 15px;" onclick="resetScores()">Reset Scores</button>
  </div>

  <div class="section">
    <h2 style="display: flex; justify-content: space-between; align-items: center;">
      Mode Display
      <button onclick="toggleModeDisplayVisibility()" id="mode-visibility-btn" style="background: none; border: none; color: var(--purple); cursor: pointer; font-size: 20px; padding: 5px;" title="Toggle Mode Display Visibility">üëÅÔ∏è</button>
    </h2>
    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 12px;">
      <div style="display: flex; gap: 10px;">
        <button class="btn" style="flex: 1;" onclick="setMode('tourney')">Tourney Play</button>
        <button class="btn" style="flex: 1;" onclick="setMode('lobby')">Open Lobby</button>
        <button class="btn" style="flex: 1;" onclick="setMode('cash')">Cash Sets</button>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn" style="flex: 1;" onclick="setMode('league')">League Play</button>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" id="dubs-toggle" onchange="handleDubsToggle(this.checked)" />
        <label for="dubs-toggle" style="color: var(--text); font-weight: 600; cursor: pointer;">Enable Dubs Overlay</label>
      </div>
    </div>
    <div id="dubs-partner-container" style="margin-top: 12px; display: none;">
      <label style="display: block; margin-bottom: 6px; color: var(--text); font-weight: 600;">Dubs Partner Name</label>
      <input type="text" id="dubs-partner" placeholder="Partner Name" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
      <small style="color: var(--muted); font-size: 12px;">Used when Dubs mode is active.</small>
      <button class="btn" style="margin-top: 10px;" onclick="saveDubsSettings()">Save Dubs Settings</button>
    </div>
    <div id="current-mode" style="text-align: center; margin-top: 10px; color: var(--muted); font-size: 14px;">
      Current: <span id="mode-text" style="color: var(--purple); font-weight: 600;">TOURNEY PLAY</span>
      <span id="mode-visibility-status" style="display: block; margin-top: 5px; font-size: 12px; color: var(--muted);"></span>
    </div>
  </div>

  <div class="section">
    <h2>BRB / Screen Control</h2>
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button class="btn" style="flex: 1;" onclick="activateBRB(5)">BRB 5min</button>
      <button class="btn" style="flex: 1;" onclick="activateBRB(10)">BRB 10min</button>
      <button class="btn" style="flex: 1;" onclick="activateBRB(15)">BRB 15min</button>
    </div>
    <button class="btn" style="margin-bottom: 10px; background: #6c757d;" onclick="deactivateScreen()">Dismiss Screen</button>
    <button class="btn" style="margin-bottom: 10px; background: var(--purple);" onclick="activateTechDifficulties()">Tech Difficulties</button>
  </div>

  <div class="section">
    <h2>Available Commands</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
      <div><strong>!sr [song]</strong> - Request a song</div>
      <div><strong>!queue</strong> - View current queue</div>
      <div><strong>!cancel</strong> - Cancel your request</div>
      <div><strong>!lastseen [user]</strong> - Check last activity</div>
      <div><strong>!lurkers</strong> - Show anonymous viewers</div>
      <div><strong>!dcd</strong> - Dead Center Darts promo</div>
      <div><strong>!prime</strong> - Prime sub promo</div>
      <div><strong>!llogb</strong> - Join our Facebook group!<br>facebook.com/groups/thelowlifesofgranboard</div>
      <div><strong>!waitlist</strong> - Join our waitlist!<br>www.lowlifesofgranboard.com/launch</div>
      <div style="color: var(--purple);"><strong>!approve [id]</strong> - Mod only</div>
      <div style="color: var(--purple);"><strong>!deny [id]</strong> - Mod only</div>
      <div style="color: var(--purple);"><strong>!skip</strong> - Mod only</div>
    </div>
  </div>

  <div class="section">
    <h2>Quick Actions</h2>
    <button class="btn" style="margin-bottom: 10px;" onclick="skipSong()">Skip Current Song</button>
    <button class="btn" style="margin-bottom: 10px;" onclick="triggerPromo()">Trigger DCD Promo</button>
    <button class="btn" style="margin-bottom: 10px; background: #ff6b6b;" onclick="resetBot()">Reset Bot (Clear All Queues)</button>
  </div>

  <div class="section">
    <h2>Bot Settings</h2>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Special Users</label>
      <div id="special-users-list" style="margin-bottom: 10px;"></div>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="new-special-user" placeholder="Username" style="flex: 1; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
        <button class="btn" onclick="addSpecialUser()" style="padding: 10px 20px;">Add</button>
      </div>
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Promo Interval (minutes)</label>
      <input type="number" id="promo-minutes" min="1" max="60" value="15" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" onchange="updatePromoInterval()" />
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">PWA Background URL</label>
      <input type="text" id="pwa-background-url" placeholder="images/background.png" value="images/background.png" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
      <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Relative path or full URL</small>
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">OBS Overlays Background URL</label>
      <input type="text" id="obs-background-url" placeholder="Leave empty for transparent" value="" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
      <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Relative path or full URL (leave empty for transparent)</small>
    </div>

    <button class="btn" onclick="saveSettings()" style="width: 100%; background: #8400ff;">Save All Settings</button>
  </div>

  <button class="btn logout-btn" onclick="logout()">Logout</button>
</div>

<script>
  const BOT_API_URL = window.location.origin.includes('localhost')
    ? 'http://localhost:8787'
    : 'https://tattoostwitch327.onrender.com';
  const FUNCTION_API_URL = window.location.origin.includes('localhost')
    ? 'http://localhost:8888'
    : 'https://tattoostwitch.netlify.app';
  const botApi = (path = '') => `${BOT_API_URL}${path}`;
  const functionApi = (path = '') => `${FUNCTION_API_URL}${path}`;
  const CORRECT_PIN = '92522';
  const OWNER_PIN = '92522';
  let scores = { player1: 0, player2: 0 };
  let dubsPartnerName = '';
  let dubsEnabled = false;
  let scoreboardSyncInterval = null;
  let scoreboardSyncPromise = null;
  let userPin = '';
  let isOwner = false;

  function setScoreDisplays(newPlayer1, newPlayer2) {
    scores.player1 = newPlayer1;
    scores.player2 = newPlayer2;
    document.getElementById('score1').textContent = newPlayer1;
    document.getElementById('score2').textContent = newPlayer2;
  }

  function normalizeScoreboardPayload(payload) {
    if (!payload) return null;
    // GET response shape: { player1: { score }, player2: { score } }
    if (payload.player1 || payload.player2) {
      return {
        player1: Number(payload.player1?.score ?? 0) || 0,
        player2: Number(payload.player2?.score ?? 0) || 0
      };
    }
    // POST response shape: DB row with snake_case columns
    if (
      Object.prototype.hasOwnProperty.call(payload, 'player1_score') ||
      Object.prototype.hasOwnProperty.call(payload, 'player2_score')
    ) {
      return {
        player1: Number(payload.player1_score ?? 0) || 0,
        player2: Number(payload.player2_score ?? 0) || 0
      };
    }
    return null;
  }

  async function syncScoreboardFromServer(force = false) {
    if (!force && scoreboardSyncPromise) {
      return scoreboardSyncPromise;
    }

    scoreboardSyncPromise = (async () => {
      try {
        const res = await fetch(functionApi('/api/scoreboard'), { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        const normalized = normalizeScoreboardPayload(data);
        if (!normalized) return;
        const { player1, player2 } = normalized;
        if (player1 !== scores.player1 || player2 !== scores.player2) {
          setScoreDisplays(player1, player2);
        }
      } catch (e) {
        console.error('Failed to sync scoreboard:', e);
      } finally {
        scoreboardSyncPromise = null;
      }
    })();

    return scoreboardSyncPromise;
  }

  async function login() {
    const pin = document.getElementById('pin-input').value;
    const errorEl = document.getElementById('login-error');

    try {
      // Try to check in with this PIN
      const checkinRes = await fetch(botApi('/api/admin/checkin'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pin, name: '' })
      });

      if (checkinRes.status === 409) {
        const data = await checkinRes.json();
        errorEl.textContent = `${data.currentAdmin.name} is currently active. Please wait.`;
        errorEl.classList.remove('hidden');
        return;
      }

      if (!checkinRes.ok) {
        errorEl.textContent = 'Incorrect PIN';
        errorEl.classList.remove('hidden');
        return;
      }

      userPin = pin;
      isOwner = pin === OWNER_PIN;
      localStorage.setItem('authenticated', 'true');
      localStorage.setItem('userPin', pin);
      showAdmin();
    } catch (e) {
      console.error('Login error:', e);
      errorEl.textContent = 'Login failed. Please try again.';
      errorEl.classList.remove('hidden');
    }
  }

  async function logout() {
    try {
      await fetch(botApi('/api/admin/checkout'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pin: userPin })
      });
    } catch (e) {
      console.error('Checkout error:', e);
    }

    localStorage.removeItem('authenticated');
    localStorage.removeItem('userPin');
    document.getElementById('admin-screen').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
    if (scoreboardSyncInterval) {
      clearInterval(scoreboardSyncInterval);
      scoreboardSyncInterval = null;
    }
  }

  function showAdmin() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('admin-screen').classList.remove('hidden');

    if (isOwner) {
      document.getElementById('admin-management').classList.remove('hidden');
      loadAdminList();
    }

    startUpdates();
  }

  async function checkAdminStatus() {
    try {
      const res = await fetch(botApi('/api/admin/current'));
      const data = await res.json();

      const nameEl = document.getElementById('current-admin-name');
      const sinceEl = document.getElementById('admin-since');
      const bootSection = document.getElementById('boot-section');
      const checkoutSection = document.getElementById('checkout-section');

      if (data.active !== false && data.name) {
        nameEl.textContent = data.name;
        if (data.checkedInAt) {
          const since = new Date(data.checkedInAt);
          sinceEl.textContent = `Since ${since.toLocaleTimeString()}`;
        }

        if (isOwner && data.pin !== userPin) {
          bootSection.classList.remove('hidden');
          checkoutSection.classList.add('hidden');
        } else if (data.pin === userPin) {
          bootSection.classList.add('hidden');
          checkoutSection.classList.remove('hidden');
        } else {
          bootSection.classList.add('hidden');
          checkoutSection.classList.add('hidden');
        }
      } else {
        nameEl.textContent = 'None';
        sinceEl.textContent = '';
        bootSection.classList.add('hidden');
        checkoutSection.classList.add('hidden');
      }
    } catch (e) {
      console.error('Failed to check admin status:', e);
    }
  }

  async function bootAdmin() {
    if (!confirm('Boot the current admin?')) return;

    try {
      const res = await fetch(botApi('/api/admin/boot'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pin: userPin })
      });

      if (res.ok) {
        alert('Admin booted successfully');
        checkAdminStatus();
      } else {
        alert('Failed to boot admin');
      }
    } catch (e) {
      alert('Failed to boot admin');
    }
  }

  async function checkoutAdmin() {
    try {
      await fetch(botApi('/api/admin/checkout'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pin: userPin })
      });
      checkAdminStatus();
    } catch (e) {
      console.error('Checkout error:', e);
    }
  }

  async function loadAdminList() {
    try {
      const res = await fetch(botApi(`/api/admin/list?pin=${userPin}`));
      const data = await res.json();

      const listEl = document.getElementById('admin-list');
      listEl.innerHTML = data.admins.map(admin => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
          <div>
            <div style="font-weight: 600;">${admin.name}</div>
            <div style="color: var(--muted); font-size: 14px;">PIN: ${admin.pin} ${admin.role === 'owner' ? '(Owner)' : ''}</div>
          </div>
          ${admin.role !== 'owner' ? `<button class="btn-small" style="background: #ff6b6b;" onclick="removeAdmin('${admin.pin}')">Remove</button>` : ''}
        </div>
      `).join('');
    } catch (e) {
      console.error('Failed to load admin list:', e);
    }
  }

  async function addAdmin() {
    const name = document.getElementById('new-admin-name').value.trim();
    const pin = document.getElementById('new-admin-pin').value.trim();

    if (!name || !pin) {
      alert('Please enter both name and PIN');
      return;
    }

    if (pin.length < 4) {
      alert('PIN must be at least 4 digits');
      return;
    }

    try {
      const res = await fetch(botApi('/api/admin/add'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ownerPin: userPin, pin, name })
      });

      if (res.ok) {
        alert('Admin added successfully');
        document.getElementById('new-admin-name').value = '';
        document.getElementById('new-admin-pin').value = '';
        loadAdminList();
      } else {
        const data = await res.json();
        alert(data.error || 'Failed to add admin');
      }
    } catch (e) {
      alert('Failed to add admin');
    }
  }

  async function removeAdmin(pin) {
    if (!confirm('Remove this admin?')) return;

    try {
      const res = await fetch(botApi('/api/admin/remove'), {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ownerPin: userPin, pin })
      });

      if (res.ok) {
        alert('Admin removed successfully');
        loadAdminList();
      } else {
        const data = await res.json();
        alert(data.error || 'Failed to remove admin');
      }
    } catch (e) {
      alert('Failed to remove admin');
    }
  }

  async function updatePendingQueue() {
    try {
      const res = await fetch(functionApi('/api/queue'));
      const data = await res.json();

      // Update now playing
      const now = data.now;
      if (now && now.title) {
        console.log('[NOW PLAYING]', now);
        document.getElementById('track-title').textContent = now.title;
        document.getElementById('track-artist').textContent = now.artist || '-';

        // Update album art
        const albumArtDiv = document.getElementById('album-art');
        if (now.albumArt) {
          console.log('[ALBUM ART]', now.albumArt);
          albumArtDiv.innerHTML = `<img src="${now.albumArt}" alt="Album Art" />`;
        } else {
          console.log('[ALBUM ART] Missing from API response');
          albumArtDiv.innerHTML = '<svg viewBox="0 0 24 24" fill="white" style="width: 64px; height: 64px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>';
        }

        // Control music notes animation
        const musicNotes = document.getElementById('music-notes');
        if (now.isPlaying) {
          musicNotes.classList.remove('paused');
        } else {
          musicNotes.classList.add('paused');
        }
        // Show requester if song was requested, otherwise playlist name, otherwise default
        // Show requester if song was requested, otherwise show playlist name
        let playlistText = '';
        if (now.requester) {
          playlistText = `SR: ${now.requester}`;
        } else if (now.playlistName) {
          playlistText = now.playlistName;
        }
        document.getElementById('track-playlist').textContent = playlistText;
        document.getElementById('play-pause-btn').textContent = now.isPlaying ? '‚è∏' : '‚ñ∂';
        isPlaying = now.isPlaying !== false; // Sync the isPlaying state
      } else {
        document.getElementById('track-title').textContent = 'No track playing';
        document.getElementById('track-artist').textContent = '-';
        document.getElementById('track-playlist').textContent = '';
        document.getElementById('play-pause-btn').textContent = '‚ñ∂';
        isPlaying = false; // Sync the isPlaying state
      }

      const pendingEl = document.getElementById('pending-queue');
      const pending = data.pending || [];

      if (pending.length === 0) {
        pendingEl.innerHTML = '<p style="color: var(--muted); text-align: center;">No pending requests</p>';
        return;
      }

      pendingEl.innerHTML = pending.map(song => `
        <div class="queue-item">
          <div class="title">${song.title}</div>
          <div class="info">${song.artist} - requested by ${song.requester}</div>
          <div class="btn-group">
            <button class="btn-small" onclick="approveSong('${song.spotifyId}')">Approve</button>
            <button class="btn-small deny" onclick="denySong('${song.spotifyId}')">Deny</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      console.error('Failed to fetch queue:', e);
    }
  }

  let isPlaying = false;
  async function togglePlayPause() {
    try {
      await fetch(functionApi('/api/play-pause'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: isPlaying ? 'pause' : 'play' })
      });
      isPlaying = !isPlaying;
      document.getElementById('play-pause-btn').textContent = isPlaying ? '‚è∏' : '‚ñ∂';
    } catch (e) {
      console.error('Failed to toggle play/pause:', e);
    }
  }

  async function approveSong(spotifyId) {
    try {
      await fetch(functionApi('/api/approve-song'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spotifyId })
      });
      updatePendingQueue();
    } catch (e) {
      alert('Failed to approve song');
    }
  }

  async function denySong(spotifyId) {
    try {
      await fetch(functionApi('/api/deny-song'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spotifyId })
      });
      updatePendingQueue();
    } catch (e) {
      alert('Failed to deny song');
    }
  }

  async function updateScore(player, delta) {
    try {
      await syncScoreboardFromServer(true);
      const updatedScores = {
        player1: scores.player1,
        player2: scores.player2
      };
      updatedScores[player] = Math.max(0, updatedScores[player] + delta);
      setScoreDisplays(updatedScores.player1, updatedScores.player2);

      const res = await fetch(functionApi('/api/scoreboard'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedScores)
      });
      const responseData = await res.json().catch(() => null);

      if (res.ok) {
        const normalized = normalizeScoreboardPayload(responseData?.scoreboard || responseData);
        if (normalized) {
          setScoreDisplays(normalized.player1, normalized.player2);
        } else {
          await syncScoreboardFromServer(true);
        }
      } else {
        console.error('Failed to update scoreboard:', responseData?.error || res.statusText);
        await syncScoreboardFromServer(true);
      }
    } catch (e) {
      console.error('Failed to update scoreboard:', e);
      await syncScoreboardFromServer(true);
    }
  }

  async function resetScores() {
    const resetPayload = { player1: 0, player2: 0 };
    setScoreDisplays(0, 0);

    try {
      const res = await fetch(functionApi('/api/scoreboard'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(resetPayload)
      });
      const responseData = await res.json().catch(() => null);
      if (res.ok) {
        const normalized = normalizeScoreboardPayload(responseData?.scoreboard || responseData);
        if (normalized) {
          setScoreDisplays(normalized.player1, normalized.player2);
        }
      } else {
        console.error('Failed to reset scoreboard:', responseData?.error || res.statusText);
      }
    } catch (e) {
      console.error('Failed to reset scoreboard:', e);
    } finally {
      await syncScoreboardFromServer(true);
    }
  }

  async function updateFollowerCount() {
    try {
      const res = await fetch(botApi('/followers'));
      const data = await res.json();
      const count = data.total || 0;
      document.getElementById('follower-count').textContent = count;
    } catch (e) {
      console.error('Failed to update follower count:', e);
    }
  }

  async function updateSubscriberCount() {
    try {
      const res = await fetch(botApi('/subscribers'));
      const data = await res.json();
      const count = data.total || 0;
      document.getElementById('subscriber-count').textContent = count;
    } catch (e) {
      console.error('Failed to update subscriber count:', e);
      document.getElementById('subscriber-count').textContent = '---';
    }
  }

  async function skipSong() {
    try {
      await fetch(functionApi('/api/skip-song'), { method: 'POST' });
      alert('Song skipped');
    } catch (e) {
      alert('Failed to skip song');
    }
  }

  async function triggerPromo(index = 0) {
    try {
      await fetch(botApi('/api/trigger-promo'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index })
      });
      alert('Promo triggered');
    } catch (e) {
      console.error('Failed to trigger promo:', e);
      alert('Failed to trigger promo');
    }
  }

  async function resetBot() {
    if (!confirm('Are you sure you want to clear all pending and approved song queues? This cannot be undone.')) {
      return;
    }

    try {
      const res = await fetch(functionApi('/api/reset-queue'), { method: 'POST' });
      const data = await res.json();
      alert(`Bot reset! Cleared ${data.cleared.pending} pending and ${data.cleared.approved} approved songs.`);
      updatePendingQueue();
    } catch (e) {
      alert('Failed to reset bot');
    }
  }

  async function setMode(mode) {
    try {
      const res = await fetch(functionApi('/api/mode'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mode })
      });
      await res.json();
      updateModeDisplay();
    } catch (e) {
      alert('Failed to set mode');
    }
  }

  function handleDubsToggle(checked) {
    const partnerValue = document.getElementById('dubs-partner').value.trim();
    if (checked && !partnerValue) {
      alert('Enter your partner name before enabling Dubs mode.');
      dubsEnabled = false;
      applyDubsUIState();
      updateModeDisplay();
      return;
    }

    dubsEnabled = checked;
    applyDubsUIState();
    updateModeDisplay();

    if (!checked) {
      persistDubsSettings(partnerValue, { silent: true });
    }
  }

  async function saveDubsSettings() {
    const partnerValue = document.getElementById('dubs-partner').value.trim();
    await persistDubsSettings(partnerValue, { silent: false });
  }

  async function persistDubsSettings(partnerValue, { silent = false } = {}) {
    if (dubsEnabled && !partnerValue) {
      if (!silent) {
        alert('Enter your partner name before enabling Dubs mode.');
      }
      dubsEnabled = false;
      applyDubsUIState();
      updateModeDisplay();
      return;
    }

    try {
      const res = await fetch(functionApi('/api/settings'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          dubsEnabled,
          dubsPartner: partnerValue
        })
      });

      if (!res.ok) throw new Error('Failed to save');

      dubsPartnerName = partnerValue;
      applyDubsUIState();
      await loadSettings(); // reload settings so toggle + OBS pick up change immediately
      if (!silent) {
        alert('Dubs settings saved!');
      }
    } catch (err) {
      if (!silent) {
        alert('Failed to save dubs settings');
      } else {
        console.error('[Dubs Settings] Failed to save:', err);
      }
    }
  }
  function toggleDubsMode() {
    const container = document.getElementById('dubs-partner-container');
    const isVisible = container.style.display !== 'none';
    if (!isVisible) {
      container.style.display = 'block';
    } else {
      container.style.display = 'none';
    }
  }

  async function updateModeDisplay() {
    try {
      const res = await fetch(functionApi('/api/mode'));
      const data = await res.json();
      const modeText = document.getElementById('mode-text');
      const modeNames = {
        'tourney': 'TOURNEY PLAY',
        'lobby': 'OPEN LOBBY',
        'cash': 'CASH SETS',
        'league': 'LEAGUE PLAY'
      };
      const shouldShowDubs = dubsEnabled === true || dubsEnabled === 'true';
      const apiMode = data.mode || 'tourney';
      const safeMode = (!shouldShowDubs && apiMode === 'dubs') ? 'tourney' : apiMode;

      if (shouldShowDubs) {
        const partner = (dubsPartnerName || '').trim();
        modeText.textContent = partner
          ? `DUBS: ${partner.toUpperCase()}`
          : 'DUBS MODE';
      } else {
        modeText.textContent = modeNames[safeMode] || 'TOURNEY PLAY';
      }
    } catch (e) {
      console.error('Failed to update mode display:', e);
    }
  }

  async function toggleModeDisplayVisibility() {
    try {
      // Get current settings first
      const settingsRes = await fetch(functionApi('/api/settings'));
      const currentSettings = await settingsRes.json();

      // Toggle visibility (settings stores strings, not booleans)
      const currentlyVisible = currentSettings.modeDisplayVisible !== 'false'; // Default to true if not set
      const newVisibility = !currentlyVisible;

      const res = await fetch(functionApi('/api/settings'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          key: 'modeDisplayVisible',
          value: newVisibility.toString()
        })
      });

      if (res.ok) {
        updateModeVisibilityUI(newVisibility);
        alert(`Mode Display ${newVisibility ? 'shown' : 'hidden'} in OBS`);
      } else {
        alert('Failed to toggle visibility');
      }
    } catch (e) {
      console.error('Failed to toggle mode display visibility:', e);
      alert('Failed to toggle visibility');
    }
  }

  function updateModeVisibilityUI(isVisible) {
    const btn = document.getElementById('mode-visibility-btn');
    const status = document.getElementById('mode-visibility-status');

    if (isVisible) {
      btn.textContent = 'üëÅÔ∏è';
      status.textContent = 'Visible in OBS';
      status.style.color = '#4caf50';
    } else {
      btn.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
      status.textContent = 'Hidden in OBS';
      status.style.color = '#ff6b6b';
    }
  }

  async function checkConnection() {
    const statusEl = document.getElementById('connection-status');
    const statusText = statusEl.querySelector('span:last-child');

    try {
      const response = await fetch(functionApi('/api/queue'));
      statusText.textContent = 'Connected';
      statusEl.className = 'status connected';
    } catch (e) {
      console.error('Connection failed:', e.message);
      statusText.textContent = 'Disconnected';
      statusEl.className = 'status disconnected';
    }
  }

  async function checkModeVisibilityUpdate() {
    try {
      const response = await fetch(functionApi('/api/settings'), { cache: 'no-store' });
      const settings = await response.json();
      const modeDisplayVisible = settings.modeDisplayVisible !== 'false';
      updateModeVisibilityUI(modeDisplayVisible);
    } catch (e) {
      console.error('Failed to check mode visibility update:', e);
    }
  }

  async function activateBRB(minutes) {
    try {
      await fetch(botApi('/api/screen-overlay'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'brb',
          isActive: true,
          durationMinutes: minutes
        })
      });
      alert(`BRB screen activated for ${minutes} minutes`);
    } catch (e) {
      alert('Failed to activate BRB screen');
    }
  }

  async function activateTechDifficulties() {
    try {
      await fetch(botApi('/api/screen-overlay'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'tech_difficulties',
          isActive: true
        })
      });
      alert('Tech Difficulties screen activated');
    } catch (e) {
      alert('Failed to activate Tech Difficulties screen');
    }
  }

  async function deactivateScreen() {
    try {
      await fetch(botApi('/api/screen-overlay'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          isActive: false
        })
      });
      alert('Screen overlay dismissed');
    } catch (e) {
      alert('Failed to dismiss screen');
    }
  }

  let specialUsers = [];

  function applyDubsUIState() {
    const toggle = document.getElementById('dubs-toggle');
    const partnerContainer = document.getElementById('dubs-partner-container');
    if (toggle) toggle.checked = dubsEnabled;
    if (partnerContainer) {
      partnerContainer.style.display = dubsEnabled ? 'block' : 'none';
    }
  }

  async function loadSettings() {
    try {
      const res = await fetch(functionApi('/api/settings'), { cache: 'no-store' });
      const data = await res.json();
      specialUsers = data.specialUsers || [];
      document.getElementById('promo-minutes').value = data.promoMinutes || 15;
      document.getElementById('player1-name').value = data.player1Name || 'TATTOO';
      document.getElementById('player2-name').value = data.player2Name || 'OPEN';
      document.getElementById('pwa-background-url').value = data.pwaBackgroundUrl || 'images/background.png';
      document.getElementById('obs-background-url').value = data.obsBackgroundUrl || '';
      document.getElementById('dubs-partner').value = data.dubsPartner || '';
      dubsPartnerName = data.dubsPartner || '';
      const rawDubsEnabled = data.dubsEnabled;
      dubsEnabled = rawDubsEnabled === true || rawDubsEnabled === 'true';
      applyDubsUIState();
      renderSpecialUsers();
      updateScoreboardLabels();
      updatePWABackground();

      // Load mode display visibility (default to true if not set)
      const modeDisplayVisible = data.modeDisplayVisible !== 'false'; // String comparison for settings
      updateModeVisibilityUI(modeDisplayVisible);
      updateModeDisplay();
    } catch (e) {
      console.error('Failed to load settings:', e);
    }
  }

  function renderSpecialUsers() {
    const list = document.getElementById('special-users-list');
    if (specialUsers.length === 0) {
      list.innerHTML = '<div style="color: var(--muted); font-size: 14px; padding: 10px; text-align: center;">No special users added</div>';
      return;
    }
    list.innerHTML = specialUsers.map(user => `
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; margin-bottom: 8px;">
        <span style="color: var(--text); font-size: 14px;">${user}</span>
        <button onclick="removeSpecialUser('${user}')" style="background: #ff6b6b; border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
      </div>
    `).join('');
  }

  function addSpecialUser() {
    const input = document.getElementById('new-special-user');
    const username = input.value.trim();
    if (!username) {
      alert('Please enter a username');
      return;
    }
    if (specialUsers.includes(username.toLowerCase())) {
      alert('User already in list');
      return;
    }
    specialUsers.push(username.toLowerCase());
    input.value = '';
    renderSpecialUsers();
  }

  function removeSpecialUser(username) {
    specialUsers = specialUsers.filter(u => u !== username);
    renderSpecialUsers();
  }

  async function saveSettings() {
    try {
      const promoMinutes = parseInt(document.getElementById('promo-minutes').value);
      const player1Name = document.getElementById('player1-name').value.trim() || 'TATTOO';
      const player2Name = document.getElementById('player2-name').value.trim() || 'OPEN';
      const pwaBackgroundUrl = document.getElementById('pwa-background-url').value.trim() || 'images/background.png';
      const obsBackgroundUrl = document.getElementById('obs-background-url').value.trim() || '';
      const dubsPartner = document.getElementById('dubs-partner').value.trim();
      const res = await fetch(functionApi('/api/settings'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          specialUsers,
          promoMinutes,
          player1Name,
          player2Name,
          pwaBackgroundUrl,
          obsBackgroundUrl,
          dubsPartner,
          dubsEnabled
        })
      });
      if (res.ok) {
        updateScoreboardLabels();
        updatePWABackground();
        dubsPartnerName = dubsPartner;
        alert('Settings saved!');
      } else {
        alert('Failed to save settings');
      }
    } catch (e) {
      alert('Failed to save settings');
    }
  }

  function updateScoreboardLabels() {
    const player1Name = document.getElementById('player1-name').value.trim() || 'TATTOO';
    const player2Name = document.getElementById('player2-name').value.trim() || 'OPEN';
    document.querySelector('.score-section:nth-child(1) label').textContent = `Player 1 (${player1Name})`;
    document.querySelector('.score-section:nth-child(2) label').textContent = `Player 2 (${player2Name})`;
  }

  function updatePWABackground() {
    const bgUrl = document.getElementById('pwa-background-url').value.trim() || 'images/background.png';
    document.body.style.background = `url('${bgUrl}') center center / cover no-repeat fixed`;
  }

  function toggleScoreboardEdit() {
    const editSection = document.getElementById('scoreboard-edit-section');
    editSection.classList.toggle('hidden');
  }

  async function saveScoreboardNames() {
    try {
      const player1Name = document.getElementById('player1-name').value.trim() || 'TATTOO';
      const player2Name = document.getElementById('player2-name').value.trim() || 'OPEN';
      const partner = document.getElementById('dubs-partner').value.trim();

      // Get current settings first
      const settingsRes = await fetch(functionApi('/api/settings'));
      const currentSettings = await settingsRes.json();

      const res = await fetch(functionApi('/api/settings'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          specialUsers: currentSettings.specialUsers || [],
          promoMinutes: currentSettings.promoMinutes || 15,
          player1Name,
          player2Name,
          pwaBackgroundUrl: currentSettings.pwaBackgroundUrl || 'images/background.png',
          obsBackgroundUrl: currentSettings.obsBackgroundUrl || '',
          dubsPartner: partner || currentSettings.dubsPartner || ''
        })
      });

      if (res.ok) {
        updateScoreboardLabels();
        alert('Player names saved!');
        toggleScoreboardEdit();
      } else {
        alert('Failed to save names');
      }
    } catch (e) {
      alert('Failed to save names');
    }
  }

  function startUpdates() {
    updatePendingQueue();
    checkConnection();
    updateModeDisplay();
    loadSettings();
    checkModeVisibilityUpdate();
    updateFollowerCount();
    updateSubscriberCount();
    syncScoreboardFromServer();
    checkAdminStatus();
    if (scoreboardSyncInterval) clearInterval(scoreboardSyncInterval);
    scoreboardSyncInterval = setInterval(syncScoreboardFromServer, 2000);
    setInterval(updatePendingQueue, 3000);
    setInterval(checkConnection, 10000);
    setInterval(updateModeDisplay, 5000);
    setInterval(checkModeVisibilityUpdate, 5000);
    setInterval(updateFollowerCount, 30000);
    setInterval(updateSubscriberCount, 30000);
    setInterval(checkAdminStatus, 5000);
  }

  // Check if already authenticated
  if (localStorage.getItem('authenticated') === 'true') {
    userPin = localStorage.getItem('userPin') || '';
    isOwner = userPin === OWNER_PIN;
    showAdmin();
  }

  // Add Enter key listener for PIN input
  document.getElementById('pin-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      login();
    }
  });

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

</body>
</html>
