<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="theme-color" content="#8B5CF6" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<title>Tattoo's Stream Control</title>
<style>
  :root {
    --purple: #8B5CF6;
    --dark: #111111;
    --text: #ffffff;
    --muted: #a3a3a3;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: url('images/background.png') center center / cover no-repeat fixed;
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
  }

  h1 {
    text-align: center;
    margin-bottom: 30px;
    color: var(--purple);
    font-size: 28px;
  }

  .login-form {
    background: rgba(17, 17, 17, 0.95);
    border: 2px solid rgba(139, 92, 246, 0.5);
    border-radius: 12px;
    padding: 30px;
    margin-top: 100px;
  }

  .login-form h2 {
    text-align: center;
    margin-bottom: 20px;
    color: var(--purple);
  }

  input {
    width: 100%;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 8px;
    color: var(--text);
    font-size: 16px;
    margin-bottom: 15px;
  }

  input:focus {
    outline: none;
    border-color: var(--purple);
  }

  .btn {
    width: 100%;
    padding: 15px;
    background: var(--purple);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn:active {
    transform: scale(0.98);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .error {
    color: #ff6b6b;
    text-align: center;
    margin-top: 10px;
  }

  .section {
    background: rgba(17, 17, 17, 0.95);
    border: 2px solid rgba(139, 92, 246, 0.5);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .section h2 {
    color: var(--purple);
    margin-bottom: 15px;
    font-size: 20px;
  }

  .queue-item {
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
  }

  .queue-item .title {
    font-weight: 600;
    margin-bottom: 5px;
  }

  .queue-item .info {
    color: var(--muted);
    font-size: 14px;
  }

  .btn-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .btn-small {
    flex: 1;
    padding: 10px;
    background: var(--purple);
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-small.deny {
    background: #ff6b6b;
  }

  .scoreboard-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .score-section {
    text-align: center;
  }

  .score-section label {
    display: block;
    color: var(--muted);
    margin-bottom: 8px;
    font-size: 14px;
  }

  .score-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .score-display {
    font-size: 32px;
    font-weight: 900;
    color: var(--purple);
    min-width: 60px;
  }

  .score-btn {
    width: 40px;
    height: 40px;
    background: var(--purple);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
  }

  .hidden {
    display: none;
  }

  .status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: 600;
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  .status.connected {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
  }

  .status.connected .status-dot {
    background: #4caf50;
    box-shadow: 0 0 8px #4caf50;
  }

  .status.disconnected {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
  }

  .status.disconnected .status-dot {
    background: #f44336;
    box-shadow: 0 0 8px #f44336;
    animation: none;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .logout-btn {
    background: #ff6b6b;
    margin-top: 20px;
  }

  .spotify-player {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .album-art-container {
    position: relative;
    flex-shrink: 0;
  }

  .album-glow {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(139, 92, 246, 0.1) 50%, rgba(168, 85, 247, 0.2) 100%);
    border-radius: 8px;
    filter: blur(12px);
    transform: scale(1.05);
  }

  .album-art {
    position: relative;
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(139, 92, 246, 0.1) 100%);
    border: 2px solid rgba(139, 92, 246, 0.4);
    border-radius: 8px;
    object-fit: cover;
    display: block;
  }

  .track-info {
    flex: 1;
  }

  .track-title {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 5px;
  }

  .track-artist {
    color: var(--muted);
    font-size: 14px;
  }

  .track-playlist {
    color: var(--primary);
    font-size: 12px;
    margin-top: 4px;
    opacity: 0.8;
  }

  .spotify-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 15px;
  }

  .control-btn {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--purple) 0%, rgba(168, 85, 247, 1) 100%);
    border: 1px solid rgba(139, 92, 246, 0.5);
    border-radius: 50%;
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }

  .control-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
  }

  .control-btn:active {
    transform: scale(0.95);
  }

  .volume-control {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .volume-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    border-radius: 3px;
    background: rgba(139, 92, 246, 0.3);
    outline: none;
  }

  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--purple) 0%, rgba(168, 85, 247, 1) 100%);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.5);
    transition: all 0.2s;
  }

  .volume-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
  }

  .volume-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--purple) 0%, rgba(168, 85, 247, 1) 100%);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.5);
    transition: all 0.2s;
  }

  .volume-slider::-moz-range-thumb:hover {
    transform: scale(1.1);
  }

  .volume-label {
    min-width: 40px;
    text-align: right;
    color: var(--purple);
    font-size: 14px;
    font-weight: 600;
  }
</style>
</head>
<body>

<div id="login-screen" class="container">
  <div class="login-form">
    <h2>Stream Control Login</h2>
    <input type="password" id="pin-input" placeholder="Enter PIN" autocomplete="off" />
    <button class="btn" onclick="login()">Login</button>
    <div id="login-error" class="error hidden"></div>
  </div>
</div>

<div id="admin-screen" class="container hidden">
  <h1>Stream Control</h1>

  <div id="connection-status" class="status disconnected">
    <span class="status-dot"></span>
    <span>Connecting...</span>
  </div>

  <div class="section">
    <h2>Now Playing</h2>
    <div class="spotify-player">
      <div class="album-art-container">
        <div class="album-glow"></div>
        <img id="album-art" class="album-art" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' fill='%238B5CF6' opacity='0.2'/%3E%3C/svg%3E" alt="Album Art" />
      </div>
      <div class="track-info">
        <div class="track-title" id="track-title">No track playing</div>
        <div class="track-artist" id="track-artist">-</div>
        <div class="track-playlist" id="track-playlist">TheTattooedLowLife</div>
      </div>
    </div>
    <div class="spotify-controls">
      <button class="control-btn" onclick="togglePlayPause()" id="play-pause-btn">‚ñ∂</button>
      <button class="control-btn" onclick="skipSong()">‚è≠</button>
      <div class="volume-control">
        <span>üîä</span>
        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="50" oninput="updateVolume(this.value)" />
        <span class="volume-label" id="volume-label">50%</span>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>Pending Song Requests</h2>
    <div id="pending-queue"></div>
  </div>

  <div class="section">
    <h2>Scoreboard</h2>
    <div class="scoreboard-controls">
      <div class="score-section">
        <label>Player 1 (TATTOO)</label>
        <div class="score-controls">
          <button class="score-btn" onclick="updateScore('player1', -1)">-</button>
          <div class="score-display" id="score1">0</div>
          <button class="score-btn" onclick="updateScore('player1', 1)">+</button>
        </div>
      </div>
      <div class="score-section">
        <label>Player 2 (OPEN)</label>
        <div class="score-controls">
          <button class="score-btn" onclick="updateScore('player2', -1)">-</button>
          <div class="score-display" id="score2">0</div>
          <button class="score-btn" onclick="updateScore('player2', 1)">+</button>
        </div>
      </div>
    </div>
    <button class="btn" style="margin-top: 15px;" onclick="resetScores()">Reset Scores</button>
  </div>

  <div class="section">
    <h2>Mode Display</h2>
    <div style="display: flex; gap: 10px;">
      <button class="btn" style="flex: 1;" onclick="setMode('tourney')">Tourney Play</button>
      <button class="btn" style="flex: 1;" onclick="setMode('lobby')">Open Lobby</button>
      <button class="btn" style="flex: 1;" onclick="setMode('cash')">Cash Sets</button>
    </div>
    <div id="current-mode" style="text-align: center; margin-top: 10px; color: var(--muted); font-size: 14px;">
      Current: <span id="mode-text" style="color: var(--purple); font-weight: 600;">TOURNEY PLAY</span>
    </div>
  </div>

  <div class="section">
    <h2>BRB / Screen Control</h2>
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
      <button class="btn" style="flex: 1;" onclick="activateBRB(5)">BRB 5min</button>
      <button class="btn" style="flex: 1;" onclick="activateBRB(10)">BRB 10min</button>
      <button class="btn" style="flex: 1;" onclick="activateBRB(15)">BRB 15min</button>
    </div>
    <button class="btn" style="margin-bottom: 10px; background: #6c757d;" onclick="deactivateScreen()">Dismiss Screen</button>
    <button class="btn" style="margin-bottom: 10px; background: var(--purple);" onclick="activateTechDifficulties()">Tech Difficulties</button>
  </div>

  <div class="section">
    <h2>Quick Actions</h2>
    <button class="btn" style="margin-bottom: 10px;" onclick="skipSong()">Skip Current Song</button>
    <button class="btn" style="margin-bottom: 10px;" onclick="triggerPromo()">Trigger DCD Promo</button>
    <button class="btn" style="margin-bottom: 10px; background: #ff6b6b;" onclick="resetBot()">Reset Bot (Clear All Queues)</button>
  </div>

  <div class="section">
    <h2>Bot Settings</h2>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Special Users</label>
      <div id="special-users-list" style="margin-bottom: 10px;"></div>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="new-special-user" placeholder="Username" style="flex: 1; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
        <button class="btn" onclick="addSpecialUser()" style="padding: 10px 20px;">Add</button>
      </div>
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Promo Interval (minutes)</label>
      <input type="number" id="promo-minutes" min="1" max="60" value="15" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" onchange="updatePromoInterval()" />
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Player 1 Name</label>
      <input type="text" id="player1-name" placeholder="TATTOO" value="TATTOO" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">Player 2 Name</label>
      <input type="text" id="player2-name" placeholder="OPEN" value="OPEN" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">PWA Background URL</label>
      <input type="text" id="pwa-background-url" placeholder="images/background.png" value="images/background.png" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
      <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Relative path or full URL</small>
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; color: var(--text); font-weight: 600;">OBS Overlays Background URL</label>
      <input type="text" id="obs-background-url" placeholder="Leave empty for transparent" value="" style="width: 100%; padding: 10px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;" />
      <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Relative path or full URL (leave empty for transparent)</small>
    </div>

    <button class="btn" onclick="saveSettings()" style="width: 100%; background: #10b981;">Save All Settings</button>
  </div>

  <button class="btn logout-btn" onclick="logout()">Logout</button>
</div>

<script>
  const CORRECT_PIN = '92522';
  let scores = { player1: 0, player2: 0 };

  function login() {
    const pin = document.getElementById('pin-input').value;
    const errorEl = document.getElementById('login-error');

    if (pin === CORRECT_PIN) {
      localStorage.setItem('authenticated', 'true');
      showAdmin();
    } else {
      errorEl.textContent = 'Incorrect PIN';
      errorEl.classList.remove('hidden');
    }
  }

  function logout() {
    localStorage.removeItem('authenticated');
    document.getElementById('admin-screen').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
  }

  function showAdmin() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('admin-screen').classList.remove('hidden');
    startUpdates();
  }

  async function updatePendingQueue() {
    try {
      const res = await fetch('/api/queue');
      const data = await res.json();

      // Update now playing
      const now = data.now;
      if (now && now.title) {
        console.log('[NOW PLAYING]', now);
        document.getElementById('track-title').textContent = now.title;
        document.getElementById('track-artist').textContent = now.artist || '-';
        if (now.albumArt) {
          console.log('[ALBUM ART]', now.albumArt);
          document.getElementById('album-art').src = now.albumArt;
        } else {
          console.log('[ALBUM ART] Missing from API response');
        }
        // Show requester if song was requested, otherwise playlist name, otherwise default
        const playlistText = now.requester || now.playlistName || 'TheTattooedLowLife';
        document.getElementById('track-playlist').textContent = playlistText;
        document.getElementById('play-pause-btn').textContent = now.isPlaying ? '‚è∏' : '‚ñ∂';
      } else {
        document.getElementById('track-title').textContent = 'No track playing';
        document.getElementById('track-artist').textContent = '-';
        document.getElementById('track-playlist').textContent = 'TheTattooedLowLife';
        document.getElementById('play-pause-btn').textContent = '‚ñ∂';
      }

      const pendingEl = document.getElementById('pending-queue');
      const pending = data.pending || [];

      if (pending.length === 0) {
        pendingEl.innerHTML = '<p style="color: var(--muted); text-align: center;">No pending requests</p>';
        return;
      }

      pendingEl.innerHTML = pending.map(song => `
        <div class="queue-item">
          <div class="title">${song.title}</div>
          <div class="info">${song.artist} - requested by ${song.requester}</div>
          <div class="btn-group">
            <button class="btn-small" onclick="approveSong('${song.spotifyId}')">Approve</button>
            <button class="btn-small deny" onclick="denySong('${song.spotifyId}')">Deny</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      console.error('Failed to fetch queue:', e);
    }
  }

  let isPlaying = false;
  async function togglePlayPause() {
    try {
      await fetch('/api/play-pause', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: isPlaying ? 'pause' : 'play' })
      });
      isPlaying = !isPlaying;
      document.getElementById('play-pause-btn').textContent = isPlaying ? '‚è∏' : '‚ñ∂';
    } catch (e) {
      console.error('Failed to toggle play/pause:', e);
    }
  }

  async function updateVolume(volume) {
    document.getElementById('volume-label').textContent = `${volume}%`;
    try {
      await fetch('/api/set-volume', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ volume: parseInt(volume) })
      });
    } catch (e) {
      console.error('Failed to update volume:', e);
    }
  }

  async function approveSong(spotifyId) {
    try {
      await fetch('/api/approve-song', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spotifyId })
      });
      updatePendingQueue();
    } catch (e) {
      alert('Failed to approve song');
    }
  }

  async function denySong(spotifyId) {
    try {
      await fetch('/api/deny-song', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spotifyId })
      });
      updatePendingQueue();
    } catch (e) {
      alert('Failed to deny song');
    }
  }

  async function updateScore(player, delta) {
    scores[player] = Math.max(0, scores[player] + delta);
    document.getElementById(player === 'player1' ? 'score1' : 'score2').textContent = scores[player];

    try {
      await fetch('/api/scoreboard', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scores)
      });
    } catch (e) {
      console.error('Failed to update scoreboard:', e);
    }
  }

  async function resetScores() {
    scores = { player1: 0, player2: 0 };
    document.getElementById('score1').textContent = '0';
    document.getElementById('score2').textContent = '0';

    try {
      await fetch('/api/scoreboard', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scores)
      });
    } catch (e) {
      console.error('Failed to reset scoreboard:', e);
    }
  }

  async function skipSong() {
    try {
      await fetch('/api/skip-song', { method: 'POST' });
      alert('Song skipped');
    } catch (e) {
      alert('Failed to skip song');
    }
  }

  async function triggerPromo() {
    try {
      await fetch('/api/trigger-promo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: 0 })
      });
      alert('Promo triggered');
    } catch (e) {
      alert('Failed to trigger promo');
    }
  }

  async function resetBot() {
    if (!confirm('Are you sure you want to clear all pending and approved song queues? This cannot be undone.')) {
      return;
    }

    try {
      const res = await fetch('/api/reset-queue', { method: 'POST' });
      const data = await res.json();
      alert(`Bot reset! Cleared ${data.cleared.pending} pending and ${data.cleared.approved} approved songs.`);
      updatePendingQueue();
    } catch (e) {
      alert('Failed to reset bot');
    }
  }

  async function setMode(mode) {
    try {
      const res = await fetch('/api/mode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mode })
      });
      const data = await res.json();
      updateModeDisplay();
    } catch (e) {
      alert('Failed to set mode');
    }
  }

  async function updateModeDisplay() {
    try {
      const res = await fetch('/api/mode');
      const data = await res.json();
      const modeText = document.getElementById('mode-text');

      const modeNames = {
        'tourney': 'TOURNEY PLAY',
        'lobby': 'OPEN LOBBY',
        'cash': 'CASH SETS'
      };

      modeText.textContent = modeNames[data.mode] || 'TOURNEY PLAY';
    } catch (e) {
      console.error('Failed to update mode display:', e);
    }
  }

  async function checkConnection() {
    const statusEl = document.getElementById('connection-status');
    const statusText = statusEl.querySelector('span:last-child');

    try {
      const response = await fetch('/api/queue');
      statusText.textContent = 'Connected';
      statusEl.className = 'status connected';
    } catch (e) {
      console.error('Connection failed:', e.message);
      statusText.textContent = 'Disconnected';
      statusEl.className = 'status disconnected';
    }
  }

  async function activateBRB(minutes) {
    try {
      await fetch('/api/screen-overlay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'brb',
          isActive: true,
          durationMinutes: minutes
        })
      });
      alert(`BRB screen activated for ${minutes} minutes`);
    } catch (e) {
      alert('Failed to activate BRB screen');
    }
  }

  async function activateTechDifficulties() {
    try {
      await fetch('/api/screen-overlay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'tech_difficulties',
          isActive: true
        })
      });
      alert('Tech Difficulties screen activated');
    } catch (e) {
      alert('Failed to activate Tech Difficulties screen');
    }
  }

  async function deactivateScreen() {
    try {
      await fetch('/api/screen-overlay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          isActive: false
        })
      });
      alert('Screen overlay dismissed');
    } catch (e) {
      alert('Failed to dismiss screen');
    }
  }

  let specialUsers = [];

  async function loadSettings() {
    try {
      const res = await fetch('/api/settings');
      const data = await res.json();
      specialUsers = data.specialUsers || [];
      document.getElementById('promo-minutes').value = data.promoMinutes || 15;
      document.getElementById('player1-name').value = data.player1Name || 'TATTOO';
      document.getElementById('player2-name').value = data.player2Name || 'OPEN';
      document.getElementById('pwa-background-url').value = data.pwaBackgroundUrl || 'images/background.png';
      document.getElementById('obs-background-url').value = data.obsBackgroundUrl || '';
      renderSpecialUsers();
      updateScoreboardLabels();
      updatePWABackground();
    } catch (e) {
      console.error('Failed to load settings:', e);
    }
  }

  function renderSpecialUsers() {
    const list = document.getElementById('special-users-list');
    if (specialUsers.length === 0) {
      list.innerHTML = '<div style="color: var(--muted); font-size: 14px; padding: 10px; text-align: center;">No special users added</div>';
      return;
    }
    list.innerHTML = specialUsers.map(user => `
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; margin-bottom: 8px;">
        <span style="color: var(--text); font-size: 14px;">${user}</span>
        <button onclick="removeSpecialUser('${user}')" style="background: #ff6b6b; border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
      </div>
    `).join('');
  }

  function addSpecialUser() {
    const input = document.getElementById('new-special-user');
    const username = input.value.trim();
    if (!username) {
      alert('Please enter a username');
      return;
    }
    if (specialUsers.includes(username.toLowerCase())) {
      alert('User already in list');
      return;
    }
    specialUsers.push(username.toLowerCase());
    input.value = '';
    renderSpecialUsers();
  }

  function removeSpecialUser(username) {
    specialUsers = specialUsers.filter(u => u !== username);
    renderSpecialUsers();
  }

  async function saveSettings() {
    try {
      const promoMinutes = parseInt(document.getElementById('promo-minutes').value);
      const player1Name = document.getElementById('player1-name').value.trim() || 'TATTOO';
      const player2Name = document.getElementById('player2-name').value.trim() || 'OPEN';
      const pwaBackgroundUrl = document.getElementById('pwa-background-url').value.trim() || 'images/background.png';
      const obsBackgroundUrl = document.getElementById('obs-background-url').value.trim() || '';
      const res = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          specialUsers,
          promoMinutes,
          player1Name,
          player2Name,
          pwaBackgroundUrl,
          obsBackgroundUrl
        })
      });
      if (res.ok) {
        updateScoreboardLabels();
        updatePWABackground();
        alert('Settings saved!');
      } else {
        alert('Failed to save settings');
      }
    } catch (e) {
      alert('Failed to save settings');
    }
  }

  function updateScoreboardLabels() {
    const player1Name = document.getElementById('player1-name').value.trim() || 'TATTOO';
    const player2Name = document.getElementById('player2-name').value.trim() || 'OPEN';
    document.querySelector('.score-section:nth-child(1) label').textContent = `Player 1 (${player1Name})`;
    document.querySelector('.score-section:nth-child(2) label').textContent = `Player 2 (${player2Name})`;
  }

  function updatePWABackground() {
    const bgUrl = document.getElementById('pwa-background-url').value.trim() || 'images/background.png';
    document.body.style.background = `url('${bgUrl}') center center / cover no-repeat fixed`;
  }

  function startUpdates() {
    updatePendingQueue();
    checkConnection();
    updateModeDisplay();
    loadSettings();
    setInterval(updatePendingQueue, 3000);
    setInterval(checkConnection, 10000);
    setInterval(updateModeDisplay, 5000);
  }

  // Check if already authenticated
  if (localStorage.getItem('authenticated') === 'true') {
    showAdmin();
  }

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

</body>
</html>
