<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="theme-color" content="#8B5CF6" />
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<title>Tattoo's Twitch</title>
<style>
  :root {
    --purple: #8B5CF6;
    --dark: #111111;
    --text: #ffffff;
    --muted: #a3a3a3;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
  }

  h1 {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
    color: var(--purple);
    font-size: 28px;
  }

  h1 img {
    width: 50px;
    height: 50px;
    object-fit: contain;
  }

  .login-form {
    background: rgba(17, 17, 17, 0.95);
    border: 2px solid rgba(139, 92, 246, 0.5);
    border-radius: 12px;
    padding: 30px;
    margin-top: 100px;
  }

  .login-form h2 {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 20px;
    color: var(--purple);
  }

  .login-form h2 img {
    width: 40px;
    height: 40px;
    object-fit: contain;
  }

  input {
    width: 100%;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 8px;
    color: var(--text);
    font-size: 16px;
    margin-bottom: 15px;
  }

  input:focus {
    outline: none;
    border-color: var(--purple);
  }

  .btn {
    width: 100%;
    padding: 15px;
    background: var(--purple);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn:active {
    transform: scale(0.98);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .error {
    color: #ff6b6b;
    text-align: center;
    margin-top: 10px;
  }

  .section {
    background: rgba(17, 17, 17, 0.95);
    border: 2px solid rgba(139, 92, 246, 0.5);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .section h2 {
    color: var(--purple);
    margin-bottom: 15px;
    font-size: 20px;
  }

  .queue-item {
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
  }

  .queue-item .title {
    font-weight: 600;
    margin-bottom: 5px;
  }

  .queue-item .info {
    color: var(--muted);
    font-size: 14px;
  }

  .btn-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .btn-small {
    flex: 1;
    padding: 10px;
    background: var(--purple);
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-small.deny {
    background: #ff6b6b;
  }

  .scoreboard-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  .score-section {
    text-align: center;
  }

  .score-section label {
    display: block;
    color: var(--muted);
    margin-bottom: 8px;
    font-size: 14px;
  }

  .score-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .score-display {
    font-size: 32px;
    font-weight: 900;
    color: var(--purple);
    min-width: 60px;
  }

  .score-btn {
    width: 40px;
    height: 40px;
    background: var(--purple);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
  }

  .hidden {
    display: none;
  }

  .status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: 600;
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  .status.connected {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
  }

  .status.connected .status-dot {
    background: #4caf50;
    box-shadow: 0 0 8px #4caf50;
  }

  .status.disconnected {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
  }

  .status.disconnected .status-dot {
    background: #f44336;
    box-shadow: 0 0 8px #f44336;
    animation: none;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .logout-btn {
    background: #ff6b6b;
    margin-top: 20px;
  }
</style>
</head>
<body>

<div id="login-screen" class="container">
  <div class="login-form">
    <h2><img src="../images/t.png" alt="Twitch Logo">Tattoo's Twitch Login</h2>
    <input type="password" id="pin-input" placeholder="Enter PIN" autocomplete="off" />
    <button class="btn" onclick="login()">Login</button>
    <div id="login-error" class="error hidden"></div>
  </div>
</div>

<div id="admin-screen" class="container hidden">
  <h1><img src="../images/t.png" alt="Twitch Logo">Tattoo's Twitch</h1>

  <div id="connection-status" class="status disconnected">
    <span class="status-dot"></span>
    <span>Connecting...</span>
  </div>

  <div class="section">
    <h2>Pending Song Requests</h2>
    <div id="pending-queue"></div>
  </div>

  <div class="section">
    <h2>Scoreboard</h2>
    <div class="scoreboard-controls">
      <div class="score-section">
        <label>Player 1 (TATTOO)</label>
        <div class="score-controls">
          <button class="score-btn" onclick="updateScore('player1', -1)">-</button>
          <div class="score-display" id="score1">0</div>
          <button class="score-btn" onclick="updateScore('player1', 1)">+</button>
        </div>
      </div>
      <div class="score-section">
        <label>Player 2 (OPEN)</label>
        <div class="score-controls">
          <button class="score-btn" onclick="updateScore('player2', -1)">-</button>
          <div class="score-display" id="score2">0</div>
          <button class="score-btn" onclick="updateScore('player2', 1)">+</button>
        </div>
      </div>
    </div>
    <button class="btn" style="margin-top: 15px;" onclick="resetScores()">Reset Scores</button>
  </div>

  <div class="section">
    <h2>Spotify Player</h2>
    <div style="display: flex; align-items: center; gap: 20px;">
      <img src="../images/testplay.png" style="width: 64px; height: 64px; cursor: pointer;" onclick="togglePlay()" />
      <div>
        <div style="font-weight: 600; margin-bottom: 5px;">Not Playing</div>
        <div style="color: var(--muted); font-size: 14px;">No track loaded</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>Available Commands</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
      <div><strong>!sr [song]</strong> - Request a song</div>
      <div><strong>!queue</strong> - View current queue</div>
      <div><strong>!cancel</strong> - Cancel your request</div>
      <div><strong>!lastseen [user]</strong> - Check last activity</div>
      <div><strong>!lurkers</strong> - Show anonymous viewers</div>
      <div><strong>!dcd</strong> - Dead Center Darts promo</div>
      <div style="color: var(--purple);"><strong>!approve [id]</strong> - Mod only</div>
      <div style="color: var(--purple);"><strong>!deny [id]</strong> - Mod only</div>
      <div style="color: var(--purple);"><strong>!skip</strong> - Mod only</div>
    </div>
  </div>

  <div class="section">
    <h2>Special Users</h2>
    <div id="special-users-list" style="margin-bottom: 10px; color: var(--muted); font-size: 14px;"></div>
    <div style="display: flex; gap: 10px;">
      <input type="text" id="new-special-user" placeholder="Add username..." style="flex: 1; margin: 0;" />
      <button class="btn-small" onclick="addSpecialUser()" style="background: var(--purple);">Add</button>
    </div>
  </div>

  <div class="section">
    <h2>Quick Actions</h2>
    <button class="btn" style="margin-bottom: 10px;" onclick="skipSong()">Skip Current Song</button>
    <button class="btn" style="margin-bottom: 10px;" onclick="triggerPromo()">Trigger DCD Promo</button>
    <button class="btn" style="margin-bottom: 10px; background: #ff6b6b;" onclick="resetBot()">Reset Bot (Clear All Queues)</button>
    <button class="btn" style="margin-bottom: 10px; background: #facc15; color: #111;" onclick="restartBot()">Restart Bot Service</button>
  </div>

  <button class="btn logout-btn" onclick="logout()">Logout</button>
</div>

<script>
  const API_URL = localStorage.getItem('apiUrl') || 'https://tattoostwitch.netlify.app';
  const ALLOWED_PINS = ['92522', '8317', '5196'];

  let scores = { player1: 0, player2: 0 };

  function login() {
    const pin = document.getElementById('pin-input').value;
    const errorEl = document.getElementById('login-error');

    if (ALLOWED_PINS.includes(pin)) {
      localStorage.setItem('authenticated', 'true');
      localStorage.setItem('userPin', pin);
      showAdmin();
    } else {
      errorEl.textContent = 'Incorrect PIN';
      errorEl.classList.remove('hidden');
    }
  }

  function logout() {
    localStorage.removeItem('authenticated');
    document.getElementById('admin-screen').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
  }

  function showAdmin() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('admin-screen').classList.remove('hidden');
    startUpdates();
  }

  async function updatePendingQueue() {
    try {
      const res = await fetch(`${API_URL}/queue`);
      const data = await res.json();

      const pendingEl = document.getElementById('pending-queue');
      const pending = data.pending || [];

      if (pending.length === 0) {
        pendingEl.innerHTML = '<p style="color: var(--muted); text-align: center;">No pending requests</p>';
        return;
      }

      pendingEl.innerHTML = pending.map(song => `
        <div class="queue-item">
          <div class="title">${song.title}</div>
          <div class="info">${song.artist} - requested by ${song.requester}</div>
          <div class="btn-group">
            <button class="btn-small" onclick="approveSong('${song.spotifyId}')">Approve</button>
            <button class="btn-small deny" onclick="denySong('${song.spotifyId}')">Deny</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      console.error('Failed to fetch queue:', e);
    }
  }

  async function approveSong(spotifyId) {
    try {
      await fetch(`${API_URL}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spotifyId })
      });
      updatePendingQueue();
    } catch (e) {
      alert('Failed to approve song');
    }
  }

  async function denySong(spotifyId) {
    try {
      await fetch(`${API_URL}/deny`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spotifyId })
      });
      updatePendingQueue();
    } catch (e) {
      alert('Failed to deny song');
    }
  }

  async function updateScore(player, delta) {
    scores[player] = Math.max(0, scores[player] + delta);
    document.getElementById(player === 'player1' ? 'score1' : 'score2').textContent = scores[player];

    try {
      await fetch(`${API_URL}/scoreboard`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scores)
      });
    } catch (e) {
      console.error('Failed to update scoreboard:', e);
    }
  }

  async function resetScores() {
    scores = { player1: 0, player2: 0 };
    document.getElementById('score1').textContent = '0';
    document.getElementById('score2').textContent = '0';

    try {
      await fetch(`${API_URL}/scoreboard`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scores)
      });
    } catch (e) {
      console.error('Failed to reset scoreboard:', e);
    }
  }

  async function skipSong() {
    try {
      await fetch(`${API_URL}/skip`, { method: 'POST' });
      alert('Song skipped');
    } catch (e) {
      alert('Failed to skip song');
    }
  }

  async function triggerPromo() {
    try {
      await fetch(`${API_URL}/trigger-promo`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: 0 })
      });
      alert('Promo triggered');
    } catch (e) {
      alert('Failed to trigger promo');
    }
  }

  async function resetBot() {
    if (!confirm('Are you sure you want to clear all pending and approved song queues? This cannot be undone.')) {
      return;
    }

    try {
      const res = await fetch(`${API_URL}/reset-bot`, { method: 'POST' });
      const data = await res.json();
      alert(`Bot reset! Cleared ${data.cleared.pending} pending and ${data.cleared.approved} approved songs.`);
      updatePendingQueue();
    } catch (e) {
      alert('Failed to reset bot');
    }
  }

  async function restartBot() {
    if (!confirm('Restart the bot service? This will disconnect overlays for ~10 seconds.')) {
      return;
    }

    try {
      const userPin = localStorage.getItem('userPin') || '92522';
      const res = await fetch(`${API_URL}/restart-bot`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pin: userPin })
      });

      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || 'Failed to restart bot');
      }

      alert(data.message || 'Restart scheduled. Give it a few seconds.');
    } catch (e) {
      alert(e.message || 'Failed to restart bot');
    }
  }

  async function checkConnection() {
    const statusEl = document.getElementById('connection-status');
    const statusText = statusEl.querySelector('span:last-child');

    try {
      await fetch(`${API_URL}/queue`);
      statusText.textContent = 'Connected';
      statusEl.className = 'status connected';
    } catch (e) {
      statusText.textContent = 'Disconnected';
      statusEl.className = 'status disconnected';
    }
  }

  async function loadSpecialUsers() {
    const listEl = document.getElementById('special-users-list');
    try {
      const res = await fetch(`${API_URL}/special-users`);
      const data = await res.json();
      const users = data.users || [];

      if (users.length === 0) {
        listEl.innerHTML = '<em>No special users configured</em>';
      } else {
        listEl.innerHTML = users.map(u => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0;">
            <span>${u}</span>
            <button onclick="removeSpecialUser('${u}')" style="background: #ff6b6b; border: none; padding: 5px 10px; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">Remove</button>
          </div>
        `).join('');
      }
    } catch (e) {
      listEl.innerHTML = '<em style="color: #ff6b6b;">Failed to load special users</em>';
    }
  }

  async function addSpecialUser() {
    const input = document.getElementById('new-special-user');
    const username = input.value.trim().toLowerCase();

    if (!username) return;

    try {
      const res = await fetch(`${API_URL}/special-users`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, action: 'add' })
      });

      if (res.ok) {
        input.value = '';
        loadSpecialUsers();
      } else {
        alert('Failed to add special user');
      }
    } catch (e) {
      alert('Error adding special user');
    }
  }

  async function removeSpecialUser(username) {
    try {
      const res = await fetch(`${API_URL}/special-users`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, action: 'remove' })
      });

      if (res.ok) {
        loadSpecialUsers();
      } else {
        alert('Failed to remove special user');
      }
    } catch (e) {
      alert('Error removing special user');
    }
  }

  function startUpdates() {
    updatePendingQueue();
    checkConnection();
    loadSpecialUsers();
    setInterval(updatePendingQueue, 3000);
    setInterval(checkConnection, 10000);
  }

  // Check if already authenticated
  if (localStorage.getItem('authenticated') === 'true') {
    showAdmin();
  }

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

</body>
</html>
